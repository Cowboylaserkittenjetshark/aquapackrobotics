# SW8 Bottom Camera Failure
The bottom camera intermittently outputs a corrupt video stream for unknown reasons. 
## Behavior / Symptoms
- The camera enumerates properly
	- As a /dev/video* device
	- Recognized by v4l2-ctl and can query supported resolutions and frame rates
		- While this is the same model of Arducam as the front camera, it does not support the same set of resolutions. There is something different about it
	- Can be read from / written to by the Arducam serial number tool
- The camera begins to output a corrupt video stream
	- This seems to happen randomly
	- This happens even without any interaction with sw8s_rust
	- Sometimes this happens in the middle of an established video stream. The majority of the stream will be corrupt, but a valid frame is received about every 2 seconds
		- If sw8s_rust is restarted while this is happening (re initializing the video streams), then opening the bottom camera feed will fail
- The error itself comes from gstreamer. Exact error documented below
### Sample Error
This output was generated by the bash script in [[bottom_camera_report#Reproducing|Reproducing]]
```bash
+ trap 'trap - SIGTERM && kill -- -10372' SIGINT SIGTERM EXIT
+ mkdir -p /tmp/cams/
+ gst-launch-1.0 v4l2src device=/dev/video1 '!' image/jpeg, width=640, height=480, framerate=30/1 '!' jpegdec '!' tee name=raw raw. '!' queue '!' videoconvert '!' appsink raw. '!' queue '!' videoconvert '!' omxh264enc bitrate=204800 control-rate=variable '!' video/x-h264,profile=baseline '!' tee name=h264 h264. '!' queue '!' h264parse config_interval=-1 '!' video/x-h264,stream-format=byte-stream,alignment=au '!' rtspclientsink location=rtsp://127.0.0.1:8554/test.mp4 h264. '!' queue '!' mpegtsmux '!' filesink location=/tmp/cams/test.mp4
Setting pipeline to PAUSED ...
Pipeline is live and does not need PREROLL ...
Progress: (open) Opening Stream
Progress: (connect) Connecting to rtsp://127.0.0.1:8554/test.mp4
Progress: (open) Retrieving server options
Progress: (open) Opened Stream
Setting pipeline to PLAYING ...
New clock: GstSystemClock
Progress: (request) Sending RECORD request
Framerate set to : 30 at NvxVideoEncoderSetParameterNvMMLiteOpen : Block : BlockType = 4 
===== NVMEDIA: NVENC =====
NvMMLiteBlockCreate : Block : BlockType = 4 
H264: Profile = 66, Level = 40 
NVMEDIA_ENC: bBlitMode is set to TRUE 
ERROR: from element /GstPipeline:pipeline0/GstJpegDec:jpegdec0: Failed to decode JPEG image
Additional debug info:
gstjpegdec.c(1413): gst_jpeg_dec_handle_frame (): /GstPipeline:pipeline0/GstJpegDec:jpegdec0:
Decode error #55: Not a JPEG file: starts with 0xb0 0x15
Execution ended after 0:00:01.520930469
Setting pipeline to NULL ...
```
## Reproducing
This issue can not be reliably reproduced. The following are potential ways to trigger the issue:
- Repeatedly start and stop the sw8s_rust program, waiting for the video stack to fully initialize between each restart
- Repeatedly reboot Seawolf until the issue occurs
- Leave the video stream running for some time (think pool test conditions, so upwards of 10 minutes) until the issue occurs (or restart sw8s_rust after some time)

This script closely mimics what sw8s_rust does internally (pipeline should be equivalent) and can be used to test just the bottom camera. I have recreated the issue successfully several times using this method. 
- ***Be sure to replace `/dev/video1` with the actual device***
- ***The RTSP server must be running and listening at the `location=` argument passed to `gst-launch-1.0`***
```bash
#!/usr/bin/env bash
set -xeuo pipefail
trap "trap - SIGTERM && kill -- -$$" SIGINT SIGTERM EXIT

mkdir -p /tmp/cams/
gst-launch-1.0 \
	v4l2src device=/dev/video1 ! image/jpeg, width=640, height=480, framerate=30/1 \
	! jpegdec ! tee name=raw \
	raw. ! queue  ! videoconvert ! appsink \
	raw. ! queue  ! videoconvert ! \
	omxh264enc bitrate=204800 control-rate=variable ! video/x-h264,profile=baseline \
	! tee name=h264 \
	h264. ! queue ! h264parse config_interval=-1 ! video/x-h264,stream-format=byte-stream,alignment=au \
	! rtspclientsink location=rtsp://127.0.0.1:8554/test.mp4 \
	h264. ! queue ! mpegtsmux ! filesink location="/tmp/cams/test.mp4"
```
## Troubleshooting attempts
- Turn it off and on again (either the Jetson or the entire system)
	- Inconsistently causes the camera to work again
	- If it does start working again, the camera usually fails again
- Swap the camera ports on the end cap (and by extension the internal USB port)
	- No difference, still fails
- Plug the camera into another device (using the USB from the internal side of the end cap)
	- Same behavior
- Adjust positioning of camera cables
	- No effect
## Testing with a spare camera
Testing with a spare Arducam in place of the bottom camera, I was not able to trigger the issue at all. This means that the issue is likely an issue with the camera itself, or less likely, an issue with the wiring (the purple cable or wiring inside the enclosure, not the end cap wiring).

If the enclosure is opened to replace the current bottom camera with this spare, before resealing, we should ensure that we cannot recreate the issue with the spare camera while it is connected through the enclosure's wiring.